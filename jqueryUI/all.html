<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>选择桌子</title>

    <link rel="stylesheet" href="../vendor/application.css">
    <link rel="stylesheet" href="../vendor/jqueryUI/jquery.ui.core.css">
    <link rel="stylesheet" href="../vendor/jqueryUI/jquery.ui.resizable.css">

    <style>
    body {
        background: none;
    }
    .table-wrap {
        margin-left: 100px;
        width: 290px;
        height: 200px;
        background: #faa523;
        padding-left: 10px;
        padding-top: 10px;
    }
    .table-wrap ul {
        list-style: none;
    }
    .table-wrap li {
        float: left;
        width: 60px;
        height: 60px;
        margin-right: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        background: #fff;
        text-align: center;
    }
    .table-wrap .large-table {
        width: 130px;
    }
    .material-wrap {
        margin-bottom: 10px;
        list-style-type: none;
    }
    .material-wrap .material {
        float: left;
        width: 75px;
        height: 75px;
        line-height: 75px;
        margin-right: 10px;
        background: #ff0;
        text-align: center;
        z-index: 10000;
    }
    .floor-wrap {
        width: 1200px;
        margin: 0 auto;
    }
    .floor {
        height: 1200px;
        background: #eee;
        border: 1px dotted #0ff;
        list-style: none;
    }
    .floor.active {
        background: #00f;
    }
    .floor .material {
        width: 75px;
        height: 75px;
        line-height: 75px;
        background: #ff0;
        text-align: center;
    }
    .floor .wrap-material {
        background: #0f0;
    }
    .floor .material .remove-btn {
        position: absolute;
        height: 10px;
        line-height: 10px;
        top: 2px;
        right: 2px;
    }
    .floor .material input {
        display: none;
    }
    .floor .material.editing input {
        display: inline;
    }
    .floor .material.editing .name {
        display: none;
    }
    .floor .wrap-material,
    .ui-draggable-dragging.wrap-material {
        width: 225px;
        height: 225px;
    }
    </style>
</head>

<body>
    <h1>选择桌子</h1>
    <div class="row">
        <div class="col-md-10">
            <div class="table-wrap clearfix">
                <ul class="clearfix">
                    <li class="table">1号桌</li>
                    <li class="table large-table">2号桌</li>
                    <li class="table">3号桌</li>
                    <li class="table">4号桌</li>
                    <li class="table">5号桌</li>
                    <li class="table">6号桌</li>
                </ul>
            </div>
        </div>
    </div>
    <p>sortable有个缺点，就是不支持中间空着。。。</p>

    将下面的物件拖入虚线区域
    <ul class="material-wrap clearfix">
        <li class="material" data-id="four-table" data-from="outer"><a href="javascript:void(0);" class="name">四人桌</a>
        </li>
        <li class="material" data-id="six-table" data-from="outer"><a href="javascript:void(0);" class="name">六人桌</a>
        </li>
        <li class="material" data-id="door" data-from="outer"><a href="javascript:void(0);" class="name">门</a>
        </li>
        <li class="material" data-id="window" data-from="outer"><a href="javascript:void(0);" class="name">窗</a>
        </li>
        <li class="material wrap-material" data-id="room" data-from="outer"><a href="javascript:void(0);" class="name">包厢</a>
        </li>
    </ul>
    <div class="floor-wrap">
        <ul class="floor">

        </ul>
    </div>


    <script src="../vendor/jquery-1.10.2.js"></script>
    <script src="../vendor/jqueryUI/jquery-ui-1.10.4.custom.js"></script>
    <script>
    $(document).ready(function() {
        $(".table-wrap ul").sortable().disableSelection();
        $(".table-wrap .table").resizable({
            grid: 70
        });

        // 栅格：60 * 60，桌子，窗，门都是 45* 45，包厢 225*225 即有15px的槽
        // var draggableOpt = {
        //     revert: 'invalid',
        //     helper: "clone",
        //     scope: "meterial",
        //     stop: function() {}
        // };

        var GRID = 80;

        $(".material-wrap .material").draggable({
            revert: 'invalid',
            helper: "clone",
            scope: "meterial",
            stop: function() {}
        }).disableSelection();

        // todo 包厢里的东西拖着走，包厢与其包含的桌子在数据上也是有层次的
        // 直接拖入包厢的问题
        var floorBox = {
            $el: $(".floor"),
            init: function(grid) {
                var self = this;
                grid = grid || 80;
                this.grid = grid;
                this.offset = this.$el.offset();
                this.zIndex = 1;
                this.registerEvent();
                this.$el.droppable({
                    scope: "meterial",
                    tolerance: "fit", // 完全进入
                    stack: ".floor .material",
                    drop: function(event, ui) {
                        var $draggable = ui.draggable;
                        var dragFrom = self.getDragFrom($draggable);
                        // if (dragFrom === 'inner' || (dragFrom === 'wrap-inner' && self.acceptable === true)) {
                        if (dragFrom === 'inner' ||  self.acceptable === true) {
                            console.log('ok');
                            return;
                        }
                        var $meterial = ui.helper.clone();
                        console.log('落在外面' + Math.random());

                        $meterial.attr('data-from', 'inner');
                        $(this).append($meterial);
                        if (dragFrom === 'wrap-inner') {
                            var $wrapOffset = $draggable.closest('.wrap-material').offset();
                            $meterial.offset({
                                left: $meterial.offset().left + 　$wrapOffset.left,
                                top: $meterial.offset().top + 　$wrapOffset.top,
                            });
                            $draggable.remove();
                        }
                        self.initMeterial($meterial);
                        self.decorate($meterial);

                        if ($meterial.hasClass('wrap-material')) {
                            $meterial.resizable({
                                grid: grid
                            });
                            $meterial.droppable({
                                scope: "meterial",
                                tolerance: "fit",
                                hoverClass: 'active',
                                greedy: true,
                                stack: ".floor .wrap-material .material",
                                accept: function($elem) {
                                    // 包厢不能嵌套包含包厢
                                    var acceptable = !$elem.hasClass('wrap-material');
                                    console.log('acceptable: %s', acceptable);
                                    self.acceptable = true;
                                    return acceptable;
                                },
                                drop: function(event, ui) {
                                    self.acceptable = false;
                                    var $draggable = ui.draggable;
                                    var $meterial;
                                    var dragFrom = self.getDragFrom($draggable);
                                    console.log('落在里面' + Math.random());
                                    var $this;
                                    $this = $(this);
                                    $meterial = ui.helper.clone();
                                    $meterial.attr('data-from', 'wrap-inner');
                                    var $prevWrap = $draggable.closest('.wrap-material');
                                    $(this).append($meterial);
                                    // if (dragFrom === 'wrap-inner' && $draggable){

                                    // }
                                    console.log(dragFrom);
                                    if (dragFrom === 'inner' || dragFrom === 'outer' ) {
                                        $meterial.css('left', $meterial.position().left - $this.position().left);
                                        $meterial.css('top', $meterial.position().top - $this.position().top);
                                    } else if (dragFrom === 'wrap-inner') {
                                        if ($draggable.parent('.wrap-material')[0] === this) {
                                            // console.log('in to in');
                                            // console.log($draggable.position());
                                        } else {
                                            var left = $prevWrap.offset().left + $meterial.position().left - $this.offset().left;
                                            var top = $prevWrap.offset().top + $meterial.position().top - $this.offset().top;
                                            $meterial.css('left', left);
                                            $meterial.css('top', top);
                                        }
                                    }
                                    if (dragFrom === 'outer') {
                                        self.decorate($meterial);
                                    } else {
                                        $draggable.remove();
                                    }
                                    self.initMeterial($meterial);
                                }
                            });
                        }
                    },
                    hoverClass: 'active'
                });
            },
            endEdit: function(ctx) {
                var $this = $(ctx);
                var $material = $this.closest('.material');
                $material.find('.name').text($this.val());
                $material.removeClass('editing');
            },
            getDragFrom: function($draggable) {
                // outer: 外部 inner:内部 wrap-inner:包厢内
                // console.log($draggable.data('from'));
                return $draggable.attr('data-from');
            },
            initMeterial: function($meterial) {
                var self = this;
                position = $meterial.offset();
                var fixedPos = this.getSnap(position); //贴近网格
                $meterial.offset(fixedPos).draggable({
                    containment: '.floor',
                    scope: "meterial",
                    helper: false,
                    // grid: [grid, grid],// 用网格移不到第一格
                    start: function(){
                        $(this).css('z-index', self.zIndex++);
                    },
                    stop: function() {
                        var offset = $(this).offset();
                        $(this).offset(self.getSnap(offset));
                    }
                }).disableSelection();
            },
            decorate: function($meterial) {
                var self = this;
                var $removeBtn = $('<a>').addClass('remove-btn').html('&times;').attr('href', 'javascript:void(0);');
                var $editInput = $('<input>').attr('type', 'text').val($meterial.find('a').text());
                $meterial.append($removeBtn);
                $meterial.append($editInput);

                $editInput.blur(function() {
                    self.endEdit(this);

                });

                $editInput.keyup(function(evt) {
                    if (evt.keyCode == 13) {
                        self.endEdit(this);
                    }
                });
            },
            registerEvent: function() {
                // 删除
                this.$el.on('click', '.material .remove-btn', function(evt) {
                    $(evt.currentTarget).closest('.material').remove();
                });

                // 重命名
                this.$el.on('dblclick', '.material a', function(evt) {
                    var $this = $(evt.currentTarget);
                    var $parent = $this.closest('.material');
                    var $input = $parent.find(':text');
                    $parent.addClass('editing');
                    $input.focus();
                    cursorMoveToEnd($input);
                });
            },
            getSnap: function(offset) { //让物件的位置贴着网格,往左上方向靠
                var grid = this.grid;
                var parentOffset = this.offset;
                var reOffset = {
                    left: offset.left - parentOffset.left,
                    top: offset.top - parentOffset.top
                };
                reOffset.left = Math.floor(reOffset.left / grid) * grid;
                reOffset.top = Math.floor(reOffset.top / grid) * grid;

                offset.left = reOffset.left + parentOffset.left;
                offset.top = reOffset.top + parentOffset.top;
                return offset;

            },
            getSelectedMaterials: function() {
                var self = this;
                var res = [];
                var $allMaterials = this.$el.find('.material');
                $allMaterials.each(function() {
                    var $this = $(this);
                    var info = {};
                    info.id = $this.data('id');
                    info.pos = self.getMaterialPos($this.offset());
                    info.name = $this.find('.name').text();
                    res.push(info);
                });
                return res;
            },
            getMaterialPos: function(offset) {
                var grid = this.grid;
                var parentOffset = this.offset;
                var reOffset = {
                    left: offset.left - parentOffset.left,
                    top: offset.top - parentOffset.top
                };
                var pos = {
                    column: reOffset.left / grid + 1,
                    row: reOffset.top / grid + 1,
                }
                return pos;
            }
        };

        function cursorMoveToEnd($input) {
            var length = $input.val().length;
            moveCursor($input[0], length, length);
        }

        function moveCursor(input, start, end) {
            start = parseInt(start, 10);
            end = parseInt(end, 10);
            if (input.setSelectionRange) {
                input.focus();
                input.setSelectionRange(start, end);
            } else if (input.createTextRange) { // IE
                var range = input.createTextRange();
                range.collapse(true);
                range.moveEnd('character', end);
                range.moveStart('character', start);
                range.inputect();
            }
        }

        floorBox.init();


    });
    </script>
</body>

</html>
